<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Courses | E-Learn Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #111;
      color: white;
      padding: 30px;
    }
    h1 {
      color: #f5dfbd;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #333;
      text-align: left;
    }
    input, button, select {
      padding: 8px;
      border-radius: 5px;
      border: none;
      margin: 5px 0;
    }
    input[type="text"] {
      width: 100%;
    }
    .form-inline {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .form-inline input, .form-inline select {
      flex: 1;
    }
    .btn {
      background: #f5dfbd;
      color: black;
      cursor: pointer;
    }
    .btn.danger {
      background: #e74c3c;
    }
    .restricted {
      text-align: center;
      margin-top: 100px;
      font-size: 1.2em;
      color: #f5dfbd;
    }
    .array-group {
      margin-top: 20px;
    }
    .array-group input {
      width: calc(100% - 40px);
      margin-bottom: 10px;
    }
    .array-entry {
      display: flex;
      gap: 10px;
      align-items: center;
    }
  </style>
</head>
<body>
  <h1>üìñ Course Manager</h1>
  <div id="auth-check" class="restricted">Verifying access...</div>
  <div id="crud-interface" style="display:none;">
    <div class="form-inline">
      <input type="text" id="title" placeholder="Course Title">
      <input type="text" id="description" placeholder="Description">
      <input type="text" id="name_identifier" placeholder="Name Identifier">
      <select id="profile_type">
        <option value="">Select Profile Type</option>
        <option value="private">Private</option>
        <option value="common">Common</option>
        <option value="prophet">Prophet</option>
        <option value="test">Test</option>
      </select>
    </div>
    <div class="array-group" id="array-section">
      <h3>Add Teaching Points ‚úçÔ∏è</h3>
      <div id="array-fields"></div>
      <button class="btn" onclick="addArrayField()">‚ûï Add Line</button>
      <button class="btn" onclick="submitCourse()">‚úÖ Done</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Title</th>
          <th>Description</th>
          <th>Slug</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="course-table">
        <!-- Dynamic rows -->
      </tbody>
    </table>
  </div>
<script>
const API_BASE = "https://z5w4jw86-3000.use2.devtunnels.ms";
const USERNAME = prompt("Enter username to access course manager:");

if (USERNAME !== "agentofgod") {
  document.getElementById('auth-check').innerHTML = "‚õî Access Denied. Admins only.";
} else {
  document.getElementById('auth-check').style.display = 'none';
  document.getElementById('crud-interface').style.display = 'block';
  loadCourses();
  addArrayField();
}

function loadCourses() {
  fetch(`${API_BASE}/courses`)
    .then(res => res.json())
    .then(data => {
      const table = document.getElementById('course-table');
      table.innerHTML = '';
      data.forEach(course => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><input type="text" value="${course.title}" onchange="updateCourse('${course.slug}', 'title', this.value)"></td>
          <td><input type="text" value="${course.description}" onchange="updateCourse('${course.slug}', 'description', this.value)"></td>
          <td>${course.slug}</td>
          <td>
            <button class="btn danger" onclick="deleteCourse('${course.slug}')">Delete</button>
          </td>
        `;
        table.appendChild(row);
      });
    });
}

function addArrayField() {
  const div = document.createElement('div');
  div.className = 'array-entry';
  div.innerHTML = `
    <input type="text" placeholder="Enter point...">
    <button onclick="this.parentElement.remove()">‚ùå</button>
  `;
  document.getElementById('array-fields').appendChild(div);
}

function submitCourse() {
  const title = document.getElementById('title').value.trim();
  const description = document.getElementById('description').value.trim();
  const profile_type = document.getElementById('profile_type').value;
  const name_identifier = document.getElementById('name_identifier').value;
  const createdAt = new Date().toLocaleString();
  const arrayLines = [...document.querySelectorAll('#array-fields input')].map(input => input.value.trim()).filter(Boolean);

  if (!title || !description || !profile_type || arrayLines.length === 0) {
    alert("üö® Please fill all fields and add at least one teaching point.");
    return;
  }

  const data = {
    title,
    description,
    profile_type,
    createdAt,
    points: arrayLines,
    name_identifier
  };

  fetch(`${API_BASE}/elearn/new_course`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  }).then(() => {
    alert("‚úÖ Course submitted successfully!");
    loadCourses();
    document.getElementById('title').value = '';
    document.getElementById('description').value = '';
    document.getElementById('profile_type').value = '';
    document.getElementById('name_identifier').value = '';
    document.getElementById('array-fields').innerHTML = '';
    addArrayField();
  });
}

function updateCourse(slug, field, value) {
  fetch(`${API_BASE}/elearn/list/${slug}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ [field]: value })
  }).then(() => loadCourses());
}

function deleteCourse(slug) {
  if (!confirm("Are you sure you want to delete this course?")) return;
  fetch(`${API_BASE}/courses/${slug}`, {
    method: 'DELETE' })
  .then(() => loadCourses());
}
</script>
</body>
</html>
