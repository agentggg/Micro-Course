<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Courses | E-Learn Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #111; color: white; }
    h1 { color: #f5dfbd; }
    .btn-custom { background: #f5dfbd; color: black; }
    .btn-danger { background: #e74c3c; }
    .restricted { text-align: center; margin-top: 100px; font-size: 1.2em; color: #f5dfbd; }
    input, select, button, textarea { margin-bottom: 10px; }
    .card {
      word-wrap: break-word;
      word-break: break-word;
      overflow-wrap: break-word;
    }
    
    .card-header span {
      display: inline-block;
      max-width: 85%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    
  </style>
</head>
<body class="p-4">

  <h1 class="text-center mb-4">üìñ Course Manager</h1>
  
  <div id="auth-check" class="restricted">Verifying access...</div>

  <div id="crud-interface" style="display:none;">
    <div class="container mb-4">
      <div class="row g-2">
        <div class="col-md-3"><input type="text" class="form-control" id="title" placeholder="Course Title"></div>
        <div class="col-md-3"><input type="text" class="form-control" id="description" placeholder="Description"></div>
        <div class="col-md-3"><input type="text" class="form-control" id="name_identifier" placeholder="Course Identifier"></div>
        <div class="col-md-3">
          <select id="profile_type" class="form-select">
            <option value="">Select Profile Type</option>
            <option value="Prophetic">Prophetic</option>
            <option value="Default">Default</option>
            <option value="Partner">Partner</option>
            <option value="Dev">Dev</option>
            <option value="Evangelism">Evangelism</option>
            <option value="NewBorn">New Born</option>
            <option value="Ministers">Ministers</option>
            <option value="Life">Life</option>
          </select>
        </div>
      </div>
    </div>

    <div class="container mb-4">
      <h4>Add Teaching Points ‚úçÔ∏è</h4>
      <div id="array-fields" class="mb-3"></div>
      <button class="btn btn-custom me-2" onclick="addArrayField()">‚ûï Add Line</button>
      <button class="btn btn-success" onclick="submitCourse()">‚úÖ Done</button>
    </div>

    <div class="container">
      <div class="row" id="course-card-container"></div>
    </div>
  </div>

  <script src="./config.js"></script>
  <script>
    const USERNAME = prompt("Enter username to access course manager:");
    if (USERNAME !== "agentofgod") {
      document.getElementById('auth-check').innerHTML = "‚õî Access Denied. Admins only.";
    } else {
      document.getElementById('auth-check').style.display = 'none';
      document.getElementById('crud-interface').style.display = 'block';
      loadCourses();
      addArrayField();
    }

    let allCourses = [];

    function loadCourses() {
      fetch(`${CONFIG.API_BASE}/elearn/list`)
        .then(res => res.json())
        .then(data => {
          allCourses = data;
          renderCourses(data);
        });
    }

    function filterCourses() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const filtered = allCourses.filter(course =>
        course.name_identifier?.toLowerCase().startsWith(searchTerm) ||
        course.description?.toLowerCase().startsWith(searchTerm)
      );
      renderCourses(filtered);
    }

    function renderCourses(courses) {
      const container = document.getElementById('course-card-container');
      container.innerHTML = '';

      courses.forEach((course, index) => {
        const cardId = `card-${index}`;
        const card = document.createElement('div');
        card.className = 'col-md-6 col-lg-4 mb-4';
        card.innerHTML = `
          <div class="card h-100 text-dark">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span><strong>üìò ${course.name_identifier || 'No Identifier'}</strong></span>
              <button class="btn btn-sm btn-primary" onclick="toggleCard('${cardId}')">‚ûï</button>
            </div>
            <div class="card-body collapse" id="${cardId}">
              <h6 class="mt-2">üìù Title</h6>
              <input type="text" class="form-control mb-2" value="${course.title || ''}" onchange="editCourse('${course._id}', 'title', this.value)">

              <h6 class="mt-2">üîó Profile Type</h6>
              <select class="form-select mb-2" onchange="editCourse('${course._id}', 'profile_type', this.value)">
                <option ${course.profile_type === 'Prophetic' ? 'selected' : ''}>Prophetic</option>
                <option ${course.profile_type === 'Default' ? 'selected' : ''}>Default</option>
                <option ${course.profile_type === 'Partner' ? 'selected' : ''}>Partner</option>
                <option ${course.profile_type === 'Dev' ? 'selected' : ''}>Dev</option>
                <option ${course.profile_type === 'Evangelism' ? 'selected' : ''}>Evangelism</option>
                <option ${course.profile_type === 'NewBorn' ? 'selected' : ''}>New Born</option>
                <option ${course.profile_type === 'Ministers' ? 'selected' : ''}>Ministers</option>
                <option ${course.profile_type === 'Life' ? 'selected' : ''}>Life</option>
              </select>

              <button class="btn btn-danger btn-sm mt-3" onclick="deleteCourse('${course._id}')">‚ùå Delete</button>
            </div>
          </div>`;
        container.appendChild(card);
      });
    }

    function editCourse(courseId, field, value) {
      const course = allCourses.find(c => c._id === courseId);
      if (!course) return;
      const updated = { ...course, [field]: value };
      fetch(`${CONFIG.API_BASE}/elearn/list/${courseId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updated)
      }).then(() => loadCourses());
    }

    function addArrayField(index = null) {
      const container = document.getElementById('array-fields');
      const div = document.createElement('div');
      div.className = 'input-group mb-2';
      div.innerHTML = `
        <textarea class="form-control" placeholder="Enter point..." rows="4"></textarea>
        <button class="btn btn-outline-secondary" onclick="addArrayField(this.parentElement)">‚ûï</button>
        <button class="btn btn-outline-danger" onclick="this.parentElement.remove()">‚ùå</button>`;
      
      if (index && index.nodeType) {
        container.insertBefore(div, index);
      } else {
        container.appendChild(div);
      }
    }

    function submitCourse() {
      const title = document.getElementById('title').value.trim();
      const description = document.getElementById('description').value.trim();
      const profile_type = document.getElementById('profile_type').value;
      const name_identifier = document.getElementById('name_identifier').value;
      const createdAt = new Date().toISOString();
      const points = [...document.querySelectorAll('#array-fields textarea')]
        .map(input => input.value.trim()).filter(Boolean);

      if (!title || !description || !profile_type || points.length === 0) {
        alert("üö® Please fill all fields and add at least one teaching point.");
        return;
      }

      const data = {
        title,
        description,
        profile_type,
        createdAt,
        points,
        name_identifier
      };

      fetch(`${CONFIG.API_BASE}/elearn/new_course`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      }).then(() => {
        alert("‚úÖ Course submitted successfully!");
        document.getElementById('title').value = '';
        document.getElementById('description').value = '';
        document.getElementById('profile_type').value = '';
        document.getElementById('name_identifier').value = '';
        document.getElementById('array-fields').innerHTML = '';
        addArrayField();
        loadCourses();
      });
    }

    function deleteCourse(courseId) {
      if (!confirm("Are you sure you want to delete this course?")) return;
      fetch(`${CONFIG.API_BASE}/elearn/courses/${courseId}`, {
        method: 'DELETE'
      }).then(() => loadCourses());
    }

    function toggleCard(cardId) {
      document.getElementById(cardId).classList.toggle('show');
    }
  </script>
</body>
</html>